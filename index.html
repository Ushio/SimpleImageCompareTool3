<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>SimpleImageCompareTool3</title>

    <script src="jquery-3.3.1.min.js"></script>
    <script src="jquery.event.move.js"></script>
    <script src="jquery.knob.js"></script>
    <script src="GlslCanvas.js"></script>
    <script src="FileSaver.js"></script>
    
    <link rel="stylesheet" href="huebee.css">
    <script src="huebee.pkgd.js"></script>

    <link rel="stylesheet" href="check.css">
    <link rel="stylesheet" href="slider.css">

    <style>
        .dragover {
            background:rgb(193, 225, 255);
        }
        .boxspan {
            display: inline-block;
            width: 100%;
            text-align: center;
            line-height:50px;
        }
    </style>
</head>

<body>
<div style="margin: 10px;">
    <div style="width: 100%; display: flex; ">
        <div id="drop-zoneL" style="height: 50px; width: 100%; border: thin solid #888888;"><span class="boxspan">Left Image (Please drop your image here)</span></div>
        <div style="width: 20px;"></div>
        <div id="drop-zoneR" style="height: 50px; width: 100%; border: thin solid #888888;"><span class="boxspan">Right Image (Please drop your image here)</span></div>
    </div>
</div>

<div style="display: flex; justify-content: center; align-items: baseline;" id="glcontainer">
    <canvas id="glcanvas" style="max-width:100%; height:auto;">
</div>

<div style="display: flex; justify-content: center; align-items: baseline; position: absolute; left: 0px; top: 0px; z-index: 10;" id="uicontainer">
    <canvas id="uicanvas" style="max-width:100%; height:auto;">
</div>

<div style="margin:10px; padding:10px; border:1px solid black;">
    <!-- align-items: center; align-items: center  -->
    <div style="display: flex; flex-wrap: wrap;">
        <div style="display: flex; flex-direction:column; align-items: center;">
                <div style="text-align: center;">Direction</div>
            <input type="text" value="0" class="direction_dial" data-width="100" data-displayInput=false data-thickness=.5 data-cursor=true>
        </div>
        
        <div style="width: 30px"></div> <!--  margin -->

        <div style="display: flex; flex-direction:column; align-items: center;">
                <div style="text-align: center;">Border</div>
                <div style="text-align: center;" id="borderlabel">2 px</div>
                <div style="height: 25px"></div> <!--  margin -->
                <input type="range" value="2" min="0" max="32" step="1" id="border" class="slider">
        </div>

        <div style="width: 30px"></div> <!--  margin -->

        <div style="display: flex; flex-direction:column; align-items: center;">
            <div style="text-align: center;">Border Color</div>
            <div style="height: 25px"></div> <!--  margin -->
            <input class="border_color" value="#000000" style="width:130px"/>
        </div>

        <div style="width: 30px"></div> <!--  margin -->

        <div style="display: flex; flex-direction:column; align-items: center;">
            <div style="text-align: center;">Labels</div>
            <div style="height: 25px"></div> <!--  margin -->
            <input value="" style="width:130px" id="Label_L_override"/>
            <div style="height: 10px"></div> <!--  margin -->
            <input value="" style="width:130px" id="Label_R_override"/>
        </div>

        <div style="width: 30px"></div> <!--  margin -->

        <div style="display: flex; flex-direction:column; align-items: center;">
            <div style="text-align: center;">Font Size</div>
            <div style="text-align: center;" id="fontsizelabel">30 px</div>
            <div style="height: 25px"></div> <!--  margin -->
            <input type="range" value="30" min="0" max="100" step="1" id="fontsize" class="slider">
        </div>

        <div style="width: 30px"></div> <!--  margin -->

        <div style="display: flex; flex-direction:column; align-items: center;">
            <div style="text-align: center;">Font Color</div>
            <div style="height: 25px"></div> <!--  margin -->
            <input class="font_color" value="#FF0000" style="width:130px"/>
        </div>

        <div style="width: 30px"></div> <!--  margin -->

        <div style="display: flex; flex-direction:column; align-items: center;">
            <div style="text-align: center;">Diff Mode</div>
            <div style="height: 20px"></div> <!--  margin -->
            <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="diffmode" onchange="didChangeDiffMode(this.checked)">
                <label class="onoffswitch-label" for="diffmode"></label>
            </div>
            <div style="height: 20px"></div> <!--  margin -->
            <div style="text-align: center; opacity:0.3;" id="diffscalelabel">100 %</div>
            <input type="range" value="100" min="100" max="500" step="1" id="diffscale" style="opacity:0.3;" class="slider">
        </div>

        <div style="display: flex; flex-direction:column; align-items: center;  margin-left: auto;">
            <div style="text-align: center;">Save</div>
            <button style="
                background: url('save.svg') no-repeat center;
                height: 100px;
                width: 100px;
                color: white;
            " onclick="onSave()"></button>
        </div>
    </div>
</div>

<a href="https://github.com/Ushio/SimpleImageCompareTool3">Github Repo</a>

<script>
'use strict';
const canvas = document.getElementById('glcanvas');
const glsl = new GlslCanvas(canvas, {preserveDrawingBuffer: true});

const uicanvas = document.getElementById('uicanvas');
const uictx = uicanvas.getContext('2d');
const compositecanvas = document.createElement('canvas');

function invokeRender() {
    glsl.forceRender = true;
    glsl.render();
    glsl.forceRender = false;
}

let L_filename = "L";
let R_filename = "R";

let angle = 0.0;

glsl.on("render", function(e) {
    const glcontainer = $('#glcontainer');
    var offset = glcontainer.offset();

    $('#uicontainer')
        .css('left', offset.left)
        .css('top', offset.top)
        .width (glcontainer.width())
        .height(glcontainer.height());

    uicanvas.width  = canvas.width;
    uicanvas.height = canvas.height;
    
    const fontsize = $("#fontsize")[0].value;
    const font_color = $(".font_color")[0].value;
    const TEXT_MARGIN = 15;

    const Location = {
        LT : 1,
        RT : 2,
        LB : 3,
        RB : 4
    };
    function drawText(text, location) {
        if(fontsize == "0") {
            return;
        }
        uictx.save();
        uictx.font = fontsize + "px Arial";
        uictx.fillStyle = font_color;
        uictx.strokeStyle = "white";

        uictx.lineWidth = parseFloat(fontsize) / 6.0;
        uictx.lineJoin = "round";
        
        let x, y;
        if(location == Location.LT || location == Location.RT){
            uictx.textBaseline = "top";
            y = TEXT_MARGIN;
        } else {
            uictx.textBaseline = "bottom";
            y = uicanvas.height - TEXT_MARGIN;
        }
        if(location == Location.LT || location == Location.LB){
            uictx.textAlign = "left";
            x = TEXT_MARGIN;
        } else {
            uictx.textAlign = "right";
            x = uicanvas.width - TEXT_MARGIN;
        }
        
        uictx.strokeText(text, x, y);
        uictx.fillText(text, x, y);
        uictx.restore();
    }

    let label_L = $("#Label_L_override")[0].value || L_filename;
    let label_R = $("#Label_R_override")[0].value || R_filename;

    if(angle < -135.0) {
        drawText(label_L, Location.RT);
        drawText(label_R, Location.LT);
    }
    else if(-135.0 <= angle && angle < -95.0) {
        drawText(label_L, Location.RT);
        drawText(label_R, Location.LB);
    }
    else if(-95.0 <= angle && angle < -85.0) {
        drawText(label_L, Location.LT);
        drawText(label_R, Location.LB);
    }
    else if(-85.0 <= angle && angle < -45.0) {
        drawText(label_L, Location.LT);
        drawText(label_R, Location.RB);
    }
    else if(-45.0 <= angle && angle < 45.0) {
        drawText(label_L, Location.LT);
        drawText(label_R, Location.RT);
    } else if(45.0 <= angle && angle < 85.0) {
        drawText(label_L, Location.LB);
        drawText(label_R, Location.RT);
    } else if(85.0 <= angle && angle < 95.0) {
        drawText(label_L, Location.LB);
        drawText(label_R, Location.LT);
    } else if(95.0 <= angle && angle < 135.0) {
        drawText(label_L, Location.RB);
        drawText(label_R, Location.LT);
    }
    else if(135.0 <= angle && angle <= 180.0) {
        drawText(label_L, Location.RT);
        drawText(label_R, Location.LT);
    }
});

// UI Drawing
// setInterval(function () {
// }, 
// 100);

$(window).resize(invokeRender);

// we don't need auto rendering loop
glsl.pause();

// Load only the Fragment Shader
var fs = `
#extension GL_OES_standard_derivatives : enable
#ifdef GL_ES
precision mediump float;
#endif
    uniform vec2  u_resolution;
    uniform vec2  u_mouselocation;
    uniform vec2  u_direction;
    uniform float u_border;
    uniform vec3  u_border_color;
    uniform float u_diffmode;
    uniform float u_diffscale;

    uniform sampler2D u_image_L;
    uniform sampler2D u_image_R;

    float border(vec2 fragcood, vec2 n, vec2 p) {
        float base = dot(p,        n);
        float x    = dot(fragcood, n);
        return x - base;
    }

    void main() {
        vec2 fragcoord = gl_FragCoord.xy;
        vec2 st = fragcoord / u_resolution.xy;

        vec4 L = texture2D(u_image_L, st);
        vec4 R = texture2D(u_image_R, st);

        if(0.0 < u_diffmode) {
            L = abs(L - R) * u_diffscale;
        }

        if(0.1 < mod(u_border, 2.0)) {
            fragcoord += vec2(0.5);
        }
        
        float b = border(fragcoord, u_direction, u_mouselocation);

        bool is_straight = abs(u_direction.x) < 1.0e-5 || abs(u_direction.y) < 1.0e-5;
        float delta = is_straight ? 0.0 : 0.9 /* feeling constant */;

        float s = smoothstep(-delta, delta, b);

        gl_FragColor = mix(L, R, s);

        if(0.0 < u_border) {
            float bar = u_border * 0.5;
            float bar_window = smoothstep(bar - delta, bar + delta, abs(b));
            gl_FragColor.rgb = mix(u_border_color, gl_FragColor.rgb, bar_window);
        }
        gl_FragColor.a = 1.0;
    }
`;
glsl.load(fs);

canvas.width = 1200;
canvas.height = 722;

L_filename = "dogs-before";
R_filename = "dogs-after";
glsl.setUniform("u_image_L", "dogs-before.jpg");
glsl.setUniform("u_image_R", "dogs-after.jpg");
glsl.setUniform("u_direction", 1.0, 0.0);
glsl.setUniform("u_mouselocation", canvas.width * 0.5, canvas.height * 0.5);
glsl.setUniform("u_border", 2);
glsl.setUniform("u_border_color", 0.0, 0.0, 0.0);
glsl.setUniform("u_diffmode", 0.0);
glsl.setUniform("u_diffscale", 1.0);

// Mouse Move & Mouse Up is need global event  -> html
// Mouse Down shouldn't work outside of canvas -> EVENT_VIEW
const EVENT_VIEW = "#uicanvas";

var down = false;
$(EVENT_VIEW).mousedown(function(e) {
    down = true;
});
$("html").mouseup(function() {
    down = false;
});

function updateMouseLocation(e) {
    if(down) {
        const scale = canvas.width / canvas.clientWidth;
        const x = e.offsetX * scale;
        const y = canvas.height - e.offsetY * scale;
        glsl.setUniform("u_mouselocation", Math.round(x), Math.round(y));
    }
}

$("html").mousemove(function(e) {
    // Coordinate transform
    // https://qiita.com/yukiB/items/cc533fbbf3bb8372a924#2-jquery%E3%81%AEoffset%E3%81%A8eventpagexy%E3%82%92%E4%BD%BF%E7%94%A8
    var offset = $('#glcanvas').offset();
    var x = e.pageX - offset.left;
    var y = e.pageY - offset.top;
    e.offsetX = x;
    e.offsetY = y;
    updateMouseLocation(e);
});
$(EVENT_VIEW).mouseleave(updateMouseLocation);
$(EVENT_VIEW).mousedown(function(e){
    down = true;
    updateMouseLocation(e);
});

// Direction
const DIAL_STEPS = 100.0;
$(".direction_dial").attr("value", DIAL_STEPS / 4).knob({
    'max' : DIAL_STEPS,
    'height' : 110,
    'fgColor' : "#2A2A2A",
    'change' : function (v) { 
        const clock = this.cv;
        const tick = (clock - DIAL_STEPS / 4.0);
        const radian = -tick / DIAL_STEPS * Math.PI * 2;
        angle = radian / (2.0 * Math.PI) * 360.0;
        if(angle <= -180.0) {
            angle += 360.0;
        }
        glsl.setUniform("u_direction", Math.cos(radian), Math.sin(radian));
    }
});

// Border
$("#border").on("input", function(e){
    const value = this.value;
    glsl.setUniform("u_border", parseFloat(value));
    $("#borderlabel").text(value + "px");
});

// Border color
var hueb_border = new Huebee( '.border_color', {
  notation: 'hex',
  saturations: 2,
});
hueb_border.on( 'change', function( color, hue, sat, lum ) {
    const R = color.slice(1, 3);
    const G = color.slice(3, 5);
    const B = color.slice(5, 7);
    const r = parseInt(R, 16) / 255.0;
    const g = parseInt(G, 16) / 255.0;
    const b = parseInt(B, 16) / 255.0;
    glsl.setUniform("u_border_color", r, g, b);
});

$('#Label_L_override').on('input', function () {
    invokeRender();
});
$('#Label_R_override').on('input', function () {
    invokeRender();
});

$("#fontsize").on("input", function(e){
    const value = this.value;
    invokeRender();
    $("#fontsizelabel").text(value + "px");
});

var hueb_font = new Huebee( '.font_color', {
  notation: 'hex',
  saturations: 2,
});
hueb_font.on( 'change', function( color, hue, sat, lum ) {
    const R = color.slice(1, 3);
    const G = color.slice(3, 5);
    const B = color.slice(5, 7);
    const r = parseInt(R, 16) / 255.0;
    const g = parseInt(G, 16) / 255.0;
    const b = parseInt(B, 16) / 255.0;
    invokeRender();
});

function didChangeDiffMode(value) {
    glsl.setUniform("u_diffmode", value ? 1.0 : 0.0);
    const op = value ? 1.0 : 0.3;
    $("#diffscalelabel").css("opacity", op);
    $("#diffscale").css("opacity", op);
}
// Border
$("#diffscale").on("input", function(e) {
    const value = this.value;
    const scale = parseFloat(value) / 100.0;
    glsl.setUniform("u_diffscale", scale);
    $("#diffscalelabel").text(value + " %");
});

// on save
function onSave() {
    compositecanvas.width = canvas.width;
    compositecanvas.height = canvas.height;
    const compositecanvasCtx = compositecanvas.getContext('2d');
    compositecanvasCtx.drawImage(canvas, 0, 0);
    compositecanvasCtx.drawImage(uicanvas, 0, 0);

    var imgdata = compositecanvas.toDataURL('image/png');
    saveAs(imgdata, "compare.png");
}


var dragoverHandler = function(e){
    e.preventDefault();
    $(this).addClass("dragover");
};
$("#drop-zoneL").on("dragover", dragoverHandler);
$("#drop-zoneR").on("dragover", dragoverHandler);

var dragleaveHandler = function(e){
    e.preventDefault();
    $(this).removeClass("dragover");
};
$("#drop-zoneL").on("dragleave", dragleaveHandler);
$("#drop-zoneR").on("dragleave", dragleaveHandler);

function rmExt(s) {
    return s.replace(/\.[^/.]+$/, "");
}
var handleDrop = function(file, sampler, isLeft) {
    if(isLeft) {
        L_filename = rmExt(file.name);
    } else {
        R_filename = rmExt(file.name);
    }

    var reader = new FileReader();
    reader.onload = function(event) {
        glsl.setUniform(sampler, event.target.result);

        const image = new Image();
        image.onload = function() {
            canvas.width = image.width;
            canvas.height = image.height;
        };
        image.src = event.target.result;
    }
    reader.readAsDataURL(file);
};
$("#drop-zoneL").on("drop", function(e) {
    e.preventDefault();
    $(this).removeClass("dragover");
    handleDrop(e.originalEvent.dataTransfer.files[0], "u_image_L", true);
});
$("#drop-zoneR").on("drop", function(e) {
    e.preventDefault();
    $(this).removeClass("dragover");
    handleDrop(e.originalEvent.dataTransfer.files[0], "u_image_R", false);
});

$("#drop-zoneL").on("click", function(e) {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = event => { 
        handleDrop(event.target.files[0], "u_image_L", true);
    };
    input.click();
});
$("#drop-zoneR").on("click", function(e) {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = event => { 
        handleDrop(event.target.files[0], "u_image_R", false);
    };
    input.click();
});

</script>
</body>
</html>
